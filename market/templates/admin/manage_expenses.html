{% extends "admin/dashboard_base.html" %}

{% block title %}Product Management{% endblock %}

{% block content %}
<div class="row pt-4">
  <div class="col-12">
    <h1 class="mb-4">Product Inventory Management</h1>
    
    <button type="button" class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addExpenseModal">
        <i class="fas fa-plus"></i> Add Expenditure
    </button>
        <!-- Total Expenditures -->
        <div class="card mb-4">
          <div class="card-body">
            <div class="row text-center">
              <div class="col-md-6">
                <h3 class="text-success">{{ total_expenses|floatformat:0 }} XAF</h3>
                <p class="mb-0">Total Recorded Expenditures</p>
              </div>
              <div class="col-md-6">
                <h3 class="text-success">{{ expenses.count }}</h3>
                <p class="mb-0">Number of Expense Records</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
          <div class="card-body">
            <form method="GET" class="row g-3">
              <div class="col-md-3">
                <label class="form-label">Expense Type</label>
                <select name="type" class="form-select">
                  <option value="">All Types</option>
                  {% for type_value, type_name in expense_types %}
                  <option value="{{ type_value }}" {% if type_value == request.GET.type %}selected{% endif %}>
                      {{ type_name }}
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-3">
                  <label class="form-label">Start Date</label>
                  <input type="date" name="start_date" class="form-control" value="{{ request.GET.start_date }}">
              </div>
              <div class="col-md-3">
                  <label class="form-label">End Date</label>
                  <input type="date" name="end_date" class="form-control" value="{{ request.GET.end_date }}">
              </div>
              
                  <button type="submit" class="btn btn-outline-success w-25 me-2">Filter</button>
                  <a href="{% url 'manage_expenses' %}" class="btn btn-outline-secondary w-25">Clear</a>
                
            </form>
          </div>
        </div>

        <!-- Expenditures Table -->
        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Receipt #</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                  {% for expense in expenses %}
                  <tr>
                    <td>{{ expense.expenses_date|date:"M d, Y" }}</td>
                    <td>
                        <span class="badge bg-secondary">{{ expense.expenses_type}}</span>
                    </td>
                    <td>{{ expense.description }}</td>
                    <td>{{ expense.amount|floatformat:0 }} XAF</td>
                    <td>{{ expense.expenses_number|default:"-" }}</td>
                    <td>
                      <a href="{% url 'delete_expenses' expense.id %}" class="btn btn-sm btn-danger me-2">
                        <i class="fas fa-trash"></i>
                      </a>
                      <!--<div class="btn-group btn-group-sm justify-center">
                        <button class="btn btn-outline-primary" data-bs-toggle="tooltip" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <a href="{% url 'delete_expenses' expense.id %}" class="btn btn-sm btn-danger me-2">
                          <i class="fas fa-trash"></i>
                        </a>
                      </div>-->
                      </td>
                    </tr>
                    {% empty %}
                    <tr>
                      <td colspan="6" class="text-center text-muted">No expenditures found</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
    </div>
  </div>

  <!-- Add Expense Modal -->
  <div class="modal fade" id="addExpenseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Expenditure</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Expense Type</label>
                        {{ form.expenses_type }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        {{ form.description }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Amount (XAF)</label>
                        {{ form.amount }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Date</label>
                        {{ form.expenses_date }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Expenditure Number (Optional)</label>
                        {{ form.expenses_number }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Expenditure</button>
                </div>
            </form>
        </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
      // Initialize tooltips
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
      var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl)
      });

      document.addEventListener('DOMContentLoaded', function() {
  console.log('=== EXPENDITURE DELETE DEBUG ===');

  // Debug: Check all delete buttons and their data
  document.querySelectorAll('.delete-expenditure-btn').forEach((button, index) => {
      const expenditureNumber = button.getAttribute('data-id');
      const name = button.getAttribute('data-name');
      console.log(`Button ${index}: Expenditure Number="${expenditureNumber}", Name="${name}"`);
      
      if (!expenditureNumber) {
          console.error(`Button ${index} has empty expenditure number!`);
          button.style.border = '2px solid red';
      }
  });

  let currentExpenditureNumber = null;

  // Delete expenditure button functionality
  document.querySelectorAll('.delete-expenditure-btn').forEach(button => {
      button.addEventListener('click', function(e) {
          e.preventDefault();
          
          currentExpenditureNumber = this.getAttribute('data-id');
          const expenditureName = this.getAttribute('data-name') || 'this expenditure';
          
          console.log('Clicked expenditure number:', currentExpenditureNumber);
          console.log('Clicked expenditure name:', expenditureName);
          
          if (!currentExpenditureNumber) {
              console.error('EMPTY EXPENDITURE NUMBER DETECTED!');
              showAlert('Error: Could not identify expenditure to delete', 'error');
              return;
          }
          
          // Show confirmation modal
          document.getElementById('deleteExpenditureName').textContent = expenditureName;
          const deleteModal = new bootstrap.Modal(document.getElementById('deleteExpenditureModal'));
          deleteModal.show();
      });
  });

  // Confirm delete button
  document.getElementById('confirmDeleteExpenditureBtn').addEventListener('click', function() {
      if (currentExpenditureNumber && currentExpenditureNumber.trim() !== '') {
          console.log('Proceeding with delete for expenditure number:', currentExpenditureNumber);
          const deleteBtn = document.querySelector(`.delete-expenditure-btn[data-id="${currentExpenditureNumber}"]`);
          const expenditureName = deleteBtn ? deleteBtn.getAttribute('data-name') : 'expenditure';
          deleteExpenditure(currentExpenditureNumber, expenditureName);
          
          const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteExpenditureModal'));
          deleteModal.hide();
      } else {
          console.error('Invalid expenditure number:', currentExpenditureNumber);
          showAlert('Error: Invalid expenditure number', 'error');
      }
  });

  // Delete expenditure function
  function deleteExpenditure(expenditureNumber, expenditureName) {
      console.log('Sending DELETE request for expenditure number:', expenditureNumber);
      
      // Show loading state
      const deleteBtn = document.querySelector(`.delete-expenditure-btn[data-id="${expenditureNumber}"]`);
      if (deleteBtn) {
          const originalHTML = deleteBtn.innerHTML;
          deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
          deleteBtn.disabled = true;

          // Construct URL with expenditure_number (UUID)
          const url = `/expenditures/delete/${expenditureNumber}/`;
          console.log('DELETE URL:', url);

          // Send DELETE request
          fetch(url, {
              method: 'DELETE',
              headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': getCookie('csrftoken')
              },
          })
          .then(response => {
              console.log('Response status:', response.status);
              if (response.ok) {
                  return response.json();
              } else {
                  throw new Error(`HTTP error! status: ${response.status}`);
              }
          })
          .then(data => {
              console.log('Delete response:', data);
              if (data.success) {
                  // Remove the expenditure row from the table
                  const expenditureRow = deleteBtn.closest('tr');
                  if (expenditureRow) {
                      expenditureRow.style.transition = 'all 0.3s ease';
                      expenditureRow.style.opacity = '0';
                      expenditureRow.style.transform = 'translateX(-100px)';
                      
                      setTimeout(() => {
                          expenditureRow.remove();
                          showAlert(data.message || 'Expenditure deleted successfully!', 'success');
                          updateExpenditureTotal();
                      }, 300);
                  }
              } else {
                  throw new Error(data.error || 'Failed to delete expenditure');
              }
          })
          .catch(error => {
              console.error('Delete error:', error);
              showAlert('Error: ' + error.message, 'error');
              // Restore button state
              deleteBtn.innerHTML = originalHTML;
              deleteBtn.disabled = false;
          });
      }
  }

  // Get CSRF token function
  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }

  // Alert function
  function showAlert(message, type = 'info') {
      const existingAlert = document.querySelector('.custom-alert');
      if (existingAlert) {
          existingAlert.remove();
      }

      const alert = document.createElement('div');
      alert.className = `custom-alert alert alert-${type} alert-dismissible fade show`;
      alert.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 9999;
          min-width: 300px;
      `;
      alert.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;

      document.body.appendChild(alert);

      setTimeout(() => {
          if (alert.parentNode) {
              alert.remove();
          }
      }, 5000);
  }

  function updateExpenditureTotal() {
      const totalElement = document.getElementById('expenditure-total');
      if (totalElement) {
          let newTotal = 0;
          document.querySelectorAll('.expenditure-amount').forEach(amountElement => {
              const amountText = amountElement.textContent.replace('XAF', '').replace(/,/g, '').trim();
              const amount = parseFloat(amountText) || 0;
              newTotal += amount;
          });
          totalElement.innerHTML = `<strong>${newTotal.toLocaleString()} XAF</strong>`;
      }
  }
});
  </script>
{% endblock %}