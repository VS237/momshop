<button id="chat-toggle" onclick="toggleChat()" style="position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; border: none; background: #FF8C00; color: white; cursor: pointer; z-index: 2000; box-shadow: 0 4px 15px rgba(255, 140, 0, 0.4); transition: transform 0.2s ease;">
    <i class="fas fa-comment-dots fa-lg"></i>
</button>

<div id="chat-window" style="display: none; position: fixed; bottom: 90px; right: 20px; width: 350px; height: 450px; background: #ffffff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); flex-direction: column; z-index: 2000; overflow: hidden; border: 1px solid #2c2c2c; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;">
    
    <div style="background: #2c2c2c; color: #ffffff; padding: 15px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #FF8C00;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-robot" style="color: #FF8C00;"></i>
            <span style="font-size: 0.95rem;">Market Assistant</span>
        </div>
        <span onclick="toggleChat()" style="cursor: pointer; font-size: 22px; line-height: 1; color: #FF8C00;">&times;</span>
    </div>

    <div id="chat-body" style="flex: 1; padding: 15px; overflow-y: auto; background: #ffffff; display: flex; flex-direction: column; gap: 12px;">
        <div style="align-self: flex-start; background: #2c2c2c; color: white; padding: 10px 14px; border-radius: 15px 15px 15px 2px; font-size: 14px; max-width: 80%; border: 1px solid #e0e0e0;">
            Hello! How can I help you with our products today?
        </div>
    </div>

    <div style="padding: 12px; background: #f9f9f9; border-top: 1px solid #eee; display: flex; gap: 8px;">
        <input type="text" id="chat-input" placeholder="Type a message..." style="flex: 1; border: 1px solid #ccc; padding: 10px 15px; border-radius: 25px; outline: none; font-size: 14px;">
        <button onclick="sendMessage()" style="background: #FF8C00; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.3s;">
            <i class="fas fa-paper-plane" style="font-size: 14px;"></i>
        </button>
    </div>
</div>
<script>
  function toggleChat() {
    const chatWindow = document.getElementById('chat-window');
    // Switch between 'none' and 'flex' (flex is better for the internal layout)
    if (chatWindow.style.display === "none") {
        chatWindow.style.display = "flex";
    } else {
        chatWindow.style.display = "none";
    }
}

async function sendMessage() {
    const input = document.getElementById('chat-input');
    const chatBody = document.getElementById('chat-body');
    const message = input.value.trim();

    if (!message) return;

    // 1. Add User Bubble
    chatBody.innerHTML += `
        <div style="align-self: flex-end; background: #FF8C00; color: white; padding: 8px 12px; border-radius: 10px; font-size: 14px; max-width: 80%;">
            ${message}
        </div>`;
    
    input.value = ''; // Clear input
    chatBody.scrollTop = chatBody.scrollHeight; // Scroll to bottom

    try {
        // 2. Send to Django
        const response = await fetch('/chatbot-response/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ message: message })
        });

        const data = await response.json();

        // 3. Add AI Bubble
        chatBody.innerHTML += `
            <div style="align-self: flex-start; background: #2c2c2c; color: white; padding: 8px 12px; border-radius: 10px; font-size: 14px; max-width: 80%;">
                ${data.reply || "Error: Could not reach AI."}
            </div>`;
        
        chatBody.scrollTop = chatBody.scrollHeight;

    } catch (error) {
        console.error("Chat Error:", error);
    }
}

// Add 'Enter' key listener
document.getElementById('chat-input')?.addEventListener('keypress', function (e) {
    if (e.key === 'Enter') sendMessage();
});
</script>